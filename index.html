<!doctype html>
<html lang="uz">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Preconnect tezlashtirish uchun -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- Critical CSS inline -->
    <style>
        html, body { 
            background-color: #ffffff; 
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%;
            overflow: hidden;
        }
        #map { 
            width: 100%; 
            height: 100%; 
            position: absolute;
            top: 0;
            left: 0;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search { background-color: #f8f8f8!important; }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        }
        .ol-control { 
            background-color: rgba(255,255,255,.4)!important; 
            padding: 2px!important; 
        }
        /* Loading spinner */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .author {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 100;
        }
    </style>
    
    <!-- Non-critical CSS defer qilish -->
    <link rel="stylesheet" href="./resources/ol.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="./resources/qgis2web.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css" media="print" onload="this.media='all'">
    
    <title>QGIS2Web Portal</title>
</head>
<body>
    <!-- Loading indicator -->
    <div id="loading">
        <div class="spinner"></div>
    </div>

    <div id="map">
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <div id="popup-content"></div>
        </div>
    </div>

    <div class="author">Mansurov Maqsadbek</div>

    <!-- JS fayllarni defer bilan yuklash -->
    <script defer src="resources/polyfills.js"></script>
    <script defer src="resources/qgis2web_expressions.js"></script>
    <script defer src="./resources/functions.js"></script>
    <script defer src="./resources/ol.js"></script>
    <script defer src="./resources/ol-layerswitcher.js"></script>
    <script defer src="./resources/Autolinker.min.js"></script>
    
    <!-- QGIS2Web qatlamlar -->
    <script defer src="layers/__1.js"></script>
    <script defer src="layers/22_2.js"></script>
    <script defer src="layers/21072025_3.js"></script>
    <script defer src="styles/__1_style.js"></script>
    <script defer src="styles/22_2_style.js"></script>
    <script defer src="styles/21072025_3_style.js"></script>
    <script defer src="./layers/layers.js"></script>
    <script defer src="./resources/qgis2web.js"></script>

    <!-- Asosiy skript - xarita tayyor bo'lgandan keyin -->
    <script>
        // Loading tugashi
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('loading').style.display = 'none';
            }, 500);
        });

        // Xarita tayyor bo'lgandan keyin ishlash
        function initMapControls() {
            if (typeof map === 'undefined') {
                setTimeout(initMapControls, 100);
                return;
            }

            // LayerSwitcher qo'shish (optimallashtirilgan)
            try {
                var layerSwitcher = new ol.control.LayerSwitcher({
                    tipLabel: 'Qatlamlarni tanlash',
                    groupSelectStyle: 'children',
                    startActive: false // Dastlab yopiq - tezroq
                });
                map.addControl(layerSwitcher);
            } catch(e) {
                console.warn('LayerSwitcher yuklanmadi:', e);
            }

            // Mening joyim tugmasi (GPS) - optimallashtirilgan
            class MyLocationControl extends ol.control.Control {
                constructor(opt_options) {
                    const options = opt_options || {};
                    const button = document.createElement('button');
                    button.innerHTML = '<i class="fas fa-location-arrow"></i>';
                    button.title = 'Mening joyim';
                    button.setAttribute('aria-label', 'Mening joyim');

                    const element = document.createElement('div');
                    element.className = 'ol-control ol-unselectable';
                    element.style.cssText = 'top:65px;left:5px;position:absolute';
                    element.appendChild(button);

                    super({ element: element, target: options.target });
                    button.addEventListener('click', this.handleLocate.bind(this), { passive: true });
                }

                handleLocate() {
                    if (!("geolocation" in navigator)) {
                        alert("Brauzeringiz geolokatsiyani qo'llab-quvvatlamaydi.");
                        return;
                    }

                    // Timeout va caching bilan optimallash
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const lon = pos.coords.longitude;
                            const lat = pos.coords.latitude;
                            const coords = ol.proj.fromLonLat([lon, lat]);

                            if (!window.userMarker) {
                                window.userMarker = new ol.Feature({
                                    geometry: new ol.geom.Point(coords)
                                });
                                window.userMarker.setStyle(new ol.style.Style({
                                    image: new ol.style.Circle({
                                        radius: 6,
                                        fill: new ol.style.Fill({ color: 'blue' }),
                                        stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                                    })
                                }));
                                const vectorSource = new ol.source.Vector({ features: [window.userMarker] });
                                window.userLayer = new ol.layer.Vector({ 
                                    source: vectorSource,
                                    updateWhileAnimating: true,
                                    updateWhileInteracting: true
                                });
                                map.addLayer(window.userLayer);
                            } else {
                                window.userMarker.getGeometry().setCoordinates(coords);
                            }

                            map.getView().animate({ 
                                center: coords, 
                                zoom: 16,
                                duration: 500 
                            });
                        },
                        (err) => {
                            alert("Joylashuvni aniqlab bo'lmadi: " + err.message);
                        },
                        {
                            enableHighAccuracy: false, // Tezroq
                            timeout: 5000,
                            maximumAge: 30000 // Cache
                        }
                    );
                }
            }

            map.addControl(new MyLocationControl());

            // Xarita render optimizatsiyasi
            map.on('rendercomplete', function() {
                // Render tugagach ba'zi optimizatsiyalar
                map.updateSize();
            });
        }

        // DOMContentLoaded da ishga tushirish
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMapControls);
        } else {
            initMapControls();
        }
    </script>
</body>
</html>
